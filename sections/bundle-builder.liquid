{% assign bundles = shop.metaobjects.bundle_template.values %}
<div class="bundle-builder-root">
  <h1>Build Your Custom Starter Kit</h1>
  
  {% if bundles.size == 0 %}
    <p>No bundles found.</p>
  {% else %}
    <ul class="bundle-list">
      {% for bundle in bundles %}
        <li 
          class="bundle-card" 
          data-bundle-id="{{ bundle.id }}"
          data-max-items="{{ bundle.max_items }}"
          data-discount="{{ bundle.bundle_discount_percent }}"
          >
          {% if bundle.bundle_image != blank %}
            <img src="{{ bundle.bundle_image | image_url: width: 300}}"
            alt="{{ bundle.bundle_name }}"
            width="300"
            height="auto"
            />
          {% endif%}

          <h2>{{ bundle.bundle_name }}</h2>

          {% if bundle.description != blank %}
            <div class="bundle-description">
              {{ bundle.description | metafield_tag }}
            </div>
          {% endif %}

          {% if bundle.bundle_discount_percent > 0 %}
            <p class="bundle-discount">Save {{ bundle.bundle_discount_percent }}%</p>
          {% endif %}

        {% assign default_products = bundle.default_items.value %}
          <div
              class="bundle-default-items"
              data-default-items="{{ default_products | map: 'id' | json }}"
              data-default-items-json='[
                {% for prod_ref in default_products %}
                  {
                    "id": {{ prod_ref.id | json }},
                    "handle": "{{ prod_ref.handle }}",
                    "title": "{{ prod_ref.title | escape }}",
                    "price": {{ prod_ref.price | json }},
                    "formattedPrice": "{{ prod_ref.price | money }}",
                    "image": "{% if prod_ref.featured_image != blank %}{{ prod_ref.featured_image | image_url: width:'200x' }}{% endif %}"
                  }{% unless forloop.last %},{% endunless %}
                {% endfor %}
              ]'
            >
              {% for prod in default_products %}
                <div class="default-item">
                  <strong>{{ prod.title }}</strong> - {{ prod.price | money }}
                </div>
              {% endfor %}
            </div>

          <div class="bundle-preview" style="display: none;"></div>
        </li>
      {% endfor %}
    </ul>
  {% endif %}
  <script src="{{ "bundle-builder.js" | asset_url }}" defer></script>
</div>

{% schema %}
  {
    "name": "Section name",
    "settings": []
  }
{% endschema %}